# path: z_realism_ai/docker-compose.yml
# description: Production Orchestration v22.1 - Unified Gateway Edition.
#              Defines the microservices topology with explicit networking
#              and resource management for high-fidelity neural inference.
#              
# ARCHITECTURAL ROLE (Hexagonal / DDD):
# 1. Gateway Layer (Proxy): Unified entry point via Nginx Reverse Proxy.
# 2. Presentation Layer (UI): Delivers localized production interfaces.
# 3. Application Layer (API): Manages RESTful logic and GPU Mutex.
# 4. Domain/Infrastructure (Worker): Executes CUDA workloads.
# 5. Event Bus (Redis): Orchestrates asynchronous tasks.
#
# author: Enrique González Gutiérrez <enrique.gonzalez.gutierrez@gmail.com>

services:
  # --- 1. EVENT BUS (MESSAGE BROKER) ---
  z-realism-broker:
    image: redis:7-alpine
    container_name: z_realism_redis
    restart: unless-stopped
    networks:
      - z-realism-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- 2. PRESENTATION LAYER (LOCAL UI) ---
  z-realism-ui:
    image: nginx:alpine
    container_name: z_realism_ui
    restart: unless-stopped
    networks:
      - z-realism-net
    volumes:
      - ./src/presentation:/usr/share/nginx/html:ro
    # Ports removed from external exposure; only accessible via Proxy.

  # --- 3. APPLICATION LAYER (BACKEND API) ---
  z-realism-api:
    build: .
    container_name: z_realism_api
    restart: unless-stopped
    networks:
      - z-realism-net
    volumes:
      - ./src:/app/src
      - hf_cache:/app/model_cache
    environment:
      - APP_HOST=0.0.0.0
      - APP_PORT=8000
      - ENVIRONMENT=production
      - HF_HOME=/app/model_cache
      - CELERY_BROKER_URL=redis://z-realism-broker:6379/0
      - CELERY_RESULT_BACKEND=redis://z-realism-broker:6379/0
    depends_on:
      z-realism-broker:
        condition: service_healthy

  # --- 4. UNIFIED GATEWAY (THE FIX) ---
  # Role: Resolves 502 Bad Gateway by providing a stable bridge between UI and API.
  z-realism-proxy:
    image: nginx:alpine
    container_name: z-realism-proxy
    restart: always
    ports:
      - "80:80" # Exposed for Ngrok / Public access
    networks:
      - z-realism-net
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - z-realism-ui
      - z-realism-api

  # --- 5. INFRASTRUCTURE LAYER (INFERENCE WORKER) ---
  z-realism-worker:
    build: .
    container_name: z_realism_worker
    restart: unless-stopped
    networks:
      - z-realism-net
    command: celery -A src.infrastructure.worker worker --loglevel=info --pool=solo
    volumes:
      - ./src:/app/src
      - hf_cache:/app/model_cache
    environment:
      - HF_HOME=/app/model_cache
      - CELERY_BROKER_URL=redis://z-realism-broker:6379/0
      - CELERY_RESULT_BACKEND=redis://z-realism-broker:6379/0
      - OFFLINE_MODE=false
      - C_FORCE_ROOT=true
    depends_on:
      z-realism-broker:
        condition: service_healthy

# --- VIRTUAL NETWORK MANIFOLD ---
networks:
  z-realism-net:
    driver: bridge

# --- PERSISTENT STORAGE MANIFOLDS ---
volumes:
  hf_cache:
    driver: local