# path: z_realism_ai/docker-compose.yml
# description: Orchestration with Horizontal Scaling.
#              UPDATED: Added multiple worker replicas for parallel users.
# author: Enrique González Gutiérrez <enrique.gonzalez.gutierrez@gmail.com>

version: '3.8'

services:
  z-realism-broker:
    image: redis:7-alpine
    container_name: z_realism_redis
    restart: unless-stopped

  z-realism-api:
    build: .
    container_name: z_realism_container
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app/src
      - hf_cache:/app/model_cache
    environment:
      - HF_HOME=/app/model_cache
      - CELERY_BROKER_URL=redis://z-realism-broker:6379/0
      - CELERY_RESULT_BACKEND=redis://z-realism-broker:6379/0
    depends_on:
      - z-realism-broker

  z-realism-worker:
    build: .
    # FIXED: Reverted to default pool with concurrency 1 per container.
    # We scale by adding more containers (replicas) to manage RAM safely.
    command: celery -A src.infrastructure.worker worker --loglevel=info --concurrency=1
    volumes:
      - ./src:/app/src
      - hf_cache:/app/model_cache
    environment:
      - HF_HOME=/app/model_cache
      - CELERY_BROKER_URL=redis://z-realism-broker:6379/0
      - CELERY_RESULT_BACKEND=redis://z-realism-broker:6379/0
      - OFFLINE_MODE=false
    # PH.D. SCALING: We spin up 2 parallel containers. 
    # Total RAM usage: ~30GB. Fits your 32GB Ubuntu system.
    deploy:
      replicas: 2
    depends_on:
      - z-realism-broker

  z-realism-dashboard:
    build: .
    container_name: z_realism_dashboard
    command: streamlit run src/presentation/dashboard.py --server.port=8501 --server.address=0.0.0.0
    ports:
      - "8501:8501"
    volumes:
      - ./src:/app/src
    environment:
      - API_URL=http://z-realism-api:8000
    depends_on:
      - z-realism-api

volumes:
  hf_cache:
